/* Plugin Template generated by Pawn Studio */

#include <sourcemod>

new const String: _QuotaFilesLocation[] = "ship/cfg/sourcemod/MapBotQuotas.cfg"
new defBotQuota;
new Handle:botQuotaCVAR;

public Plugin:myinfo = 
{
	name = "Map Bot Quotas",
	author = "Joe9",
	description = "Allows maps to use specific bot quotas. Specify quotas in: /ship/cfg/sourcemod/MapBotQuotas.cfg. If a quota isn't found for a map the server.cfg's quota will be used.",
	version = "1.0",
	url = ""
}

public OnPluginStart()
{
	botQuotaCVAR = FindConVar("bot_quota");
	defBotQuota = GetConVarInt(botQuotaCVAR);
}

public OnMapStart() 
{
	new quota = defBotQuota;
		
		/*1.Get the name of the current map:*/
		new String:currentMap[20];
		GetCurrentMap(currentMap,20);
		
		//2.If BotQuotas.cfg doesn't exsist try to create it:
		new Handle:mapQuotas = CreateKeyValues("BotQuotas");
		if(!FileToKeyValues(mapQuotas,_QuotaFilesLocation))
		{
			PrintToServer("ERROR: BotQuoates.cfg doesn't exsist.");
			KeyValuesToFile(mapQuotas,_QuotaFilesLocation);
			
			if(!FileToKeyValues(mapQuotas,_QuotaFilesLocation))
			{
				PrintToServer("ERROR: Failed to create: %s. This bot quotas plugin won't be usable until this file exsists.",_QuotaFilesLocation);
			}
		}
		
		else
		{
			//3.IF a specific quota has been specified for the current map, get it:*/
			if(!KvJumpToKey(mapQuotas,currentMap))
			{
				PrintToServer("No Bot quota for the current map (%s) was found in: %s, the default bot quota will be used.",currentMap,_QuotaFilesLocation);
			}
			
			else
			{
				quota = KvGetNum(mapQuotas,"quota",-1);
			
				if(quota == -1)
				{
					PrintToServer("ERROR: The current map (%s) was found in %s but the command: quota ,was not found. So the default bot quota will be used.",currentMap,_QuotaFilesLocation);
					quota = defBotQuota;
				}
			}
		}
		
		CloseHandle(mapQuotas);
		
		/*4. IF a quota was found for the map in BotQuotas.cfg, change the quota from its default value to its specified value:*/
		SetConVarInt(botQuotaCVAR,quota);
}