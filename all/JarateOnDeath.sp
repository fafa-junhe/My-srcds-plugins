/* Plugin Template generated by Pawn Studio */

#include <sourcemod>
#include <tf2>
#include <sdktools>

#define SND "weapons/jar_explode.wav"

new bool:has[33];

public Plugin:myinfo = 
{
	name = "Jarate-Explode on death",
	author = "Booster",
	description = "<- Description ->",
	version = "1.0",
	url = "<- URL ->"
}

public OnPluginStart()
{
	RegAdminCmd("sm_jarondeath", Enable, ADMFLAG_GENERIC)
	HookEvent("player_death",PlayerDeath);
	PrecacheSound(SND);
}

public Action:Enable(client, args) {
	new String:name[32]
	new target
	GetCmdArg(1, name, sizeof(name));
	target = FindTarget(client, name);
	new String:name1[32]
	GetClientName(target, name1, 32)
	has[target] = !has[target];
	if (has[target]){
		PrintToConsole(client, "%s will now piss on death!", name1)
		PrintToChatAll("%s will now piss on death!", name1)
	} else {
		PrintToConsole(client, "%s pissed off", name1)
		PrintToChatAll("%s pissed off", name1)
	}
	return Plugin_Handled
}

public Action:PlayerDeath(Handle:event,const String:name[], bool:dontBroadcast)
{
	new victimID = GetEventInt(event, "userid")
	new victim = GetClientOfUserId(victimID);
	if (has[victim]) {
		new Float:pos[3];
		new max = GetMaxClients()
		GetClientAbsOrigin(victim, pos)
		for (new i=1; i<=max; i++) {
			new Float:vpos[3];
			GetClientAbsOrigin(i, vpos);
			if (GetVectorDistance(pos, vpos, false)<250 && IsPlayerAlive(i) && IsClientInGame(i)) {
				TF2_AddCondition(i, TFCond_Jarated, 8.0);
				EmitSoundToAll(SND, i)
			}
		}
		
	}
}

public OnClientConnected(client) {
	has[client] = false;
}