/* Plugin Template generated by Pawn Studio */

#include <sourcemod>
#include <tf2_stocks>

new g_cloakOffset;
new g_condOffset;
new maxplayers;
new Handle:cloakValue

public Plugin:myinfo = 
{
	name = "Cloak Syphon",
	author = "Muridias",
	description = "Gives spies extra cloak when frags a player and regen cloak at dispensers and from medics. ",
	version = "1.1",
	url = "www.bhslaughterhouse.com/tf2/forums"
}

public OnPluginStart(){
	g_cloakOffset = FindSendPropInfo("CTFPlayer", "m_flCloakMeter");
	g_condOffset = FindSendPropInfo("CTFPlayer","m_nPlayerCond");
	
	HookEvent("player_death", Event_PlayerDeath);
	
	cloakValue = CreateConVar("sm_cloaksyphon", "15", "How much cloak to add", FCVAR_PROTECTED);
}

public OnMapStart(){
	maxplayers = GetMaxClients();
}

public OnGameFrame(){
	for (new i=1; i<=maxplayers; i++){
		if(IsClientInGame(i) && !IsClientObserver(i) && !IsFakeClient(i)){
			if(TF2_GetPlayerClass(i) == TFClass_Spy){
				setCloakValueRegen(i);
			}
		}
	}
}

setCloakValueRegen(client){
	new Float:entValue = GetEntDataFloat(client, g_cloakOffset);
	new cond = GetEntData(client, g_condOffset);
	if(cond == 4096 || cond == 4100 || cond == 4104)
	{ 
		SetEntDataFloat(client, g_cloakOffset, entValue + 0.25);
	}
}

setCloakValueDeath(client, damagebits, customkill){
	new Float:offsetValue = GetEntDataFloat(client, g_cloakOffset);
	new Float:cvarValue = GetConVarFloat(cloakValue);
	new Float:sum = offsetValue + cvarValue;
	if(TF2_GetPlayerClass(client) == TFClass_Spy && damagebits == 1052802 && customkill == 2){
		SetEntDataFloat(client, g_cloakOffset, Float:sum);
		PrintToChat(client, "\x04%i was added to cloak meter", cvarValue);
	}
	else if(TF2_GetPlayerClass(client) == TFClass_Spy && damagebits == 4226 && customkill == 2)
	{
		SetEntDataFloat(client, g_cloakOffset, Float:sum);
		PrintToChat(client, "\x04%i was added to cloak meter", cvarValue);
	}
}

public Action:Event_PlayerDeath(Handle:event, const String:name[], bool:dontBroadcast){
	new attacker = GetClientOfUserId(GetEventInt(event, "attacker"));
	decl String:weapon[64];
	GetEventString(event, "weapon", weapon, sizeof(weapon));
	new damagebits = GetEventInt(event, "damagebits");
	new customkill = GetEventInt(event, "customkill");
	
	setCloakValueDeath(attacker, damagebits, customkill);
}

