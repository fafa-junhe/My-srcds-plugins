/* Plugin Template generated by Pawn Studio */

#include <sourcemod>
#include <sdktools>
#include <tf2_stocks>

#define PLUGIN_VERSION			"0.6"

#define CVAR_VERSION			0
#define CVAR_MESSAGE			1
#define CVAR_ENABLE				2
#define CVAR_BROUNDTIME			3
#define CVAR_FFIRE				4
#define CVAR_PRINT				5
#define NUM_CVARS				6

#pragma semicolon 1

new Handle:g_cvars[NUM_CVARS] = INVALID_HANDLE;

public Plugin:myinfo = 
{
	name = "Super Move",
	author = "Jindo",
	description = "Enable friendly fire at the end of rounds.",
	version = PLUGIN_VERSION,
	url = "http://www.topaz-games.com/"
}

public OnPluginStart()
{
	g_cvars[CVAR_VERSION] = CreateConVar("smove_version", PLUGIN_VERSION, "Version of the plugin.", FCVAR_NOTIFY|FCVAR_REPLICATED);
	g_cvars[CVAR_MESSAGE] = CreateConVar("smove_message", "1", "1 enables the center message which appears when friendly fire is activated/deactivated.", FCVAR_PLUGIN);
	g_cvars[CVAR_ENABLE] = CreateConVar("smove_enable", "1", "1 enables the plugin.", FCVAR_PLUGIN);
	g_cvars[CVAR_PRINT] = CreateConVar("smove_printname", "Friendly Fire", "Text to show in the \"X engaged/disengaged\" messages (if smove_message is non-zero.)", FCVAR_PLUGIN);
	
	g_cvars[CVAR_BROUNDTIME] = FindConVar("mp_bonusroundtime");
	g_cvars[CVAR_FFIRE] = FindConVar("mp_friendlyfire");
	
	HookEvent("teamplay_win_panel", Event_FFOn, EventHookMode_PostNoCopy);
	HookEvent("teamplay_round_start", Event_FFOff);
	
	HookEvent("player_death", Event_PlayerDeath, EventHookMode_Pre);
}

public Action:Event_FFOn(Handle:event, const String:name[], bool:dontBroadcast)
{
	new Handle:svtags = FindConVar("sv_tags");
	new sflags = GetConVarFlags(svtags);
	sflags &= ~FCVAR_NOTIFY;
	SetConVarFlags(svtags, sflags);
	new bool:enableSMove = GetConVarBool(g_cvars[CVAR_ENABLE]);
	if (!enableSMove)
	{
		return Plugin_Continue;
	}
	
	SetConVarBool(g_cvars[CVAR_FFIRE], true, true);
	
	new bool:messageEnable = GetConVarBool(g_cvars[CVAR_MESSAGE]);
	
	if (messageEnable)
	{
		decl String:printname[64];
		GetConVarString(g_cvars[CVAR_PRINT], printname, sizeof(printname));
		PrintCenterTextAll("%s in action.", printname);
	}
	
	new Float:left = GetConVarFloat(g_cvars[CVAR_BROUNDTIME]);
	CreateTimer(left, Timer_FFOff);
	
	return Plugin_Handled;
	
}

public Action:Event_FFOff(Handle:event, const String:name[], bool:dontBroadcast)
{
	new Handle:svtags = FindConVar("sv_tags");
	new sflags = GetConVarFlags(svtags);
	sflags &= ~FCVAR_NOTIFY;
	SetConVarFlags(svtags, sflags);
	new Handle:ff = FindConVar("mp_friendlyfire");
	new flags = GetConVarFlags(ff);
	flags &= ~FCVAR_NOTIFY;
	SetConVarFlags(ff, flags);
	SetConVarBool(ff, false);
	
	return Plugin_Handled;
	
}

public Action:Event_PlayerDeath(Handle:event, const String:name[], bool:dontBroadcast)
{
	new client = GetClientOfUserId(GetEventInt(event, "attacker"));
	new userid = GetClientOfUserId(GetEventInt(event, "userid"));
	if (GetClientTeam(client) == GetClientTeam(userid))
	{
		return Plugin_Handled;
	}
	return Plugin_Continue;
}

public Action:Timer_FFOff(Handle:timer, any:client)
{
	new bool:messageEnable = GetConVarBool(g_cvars[CVAR_MESSAGE]);
	if (messageEnable)
	{
		decl String:printname[64];
		GetConVarString(g_cvars[CVAR_PRINT], printname, sizeof(printname));
		PrintCenterTextAll("%s disengaged.", printname);
	}
}
